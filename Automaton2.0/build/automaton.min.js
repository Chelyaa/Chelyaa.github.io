function Automaton(t,e,i,n,s,r,a,h){this.mainClass=h,this.w=t,this.h=e,this.x=r,this.y=a,this.wB=n,this.hB=s,this.scene=this.mainClass.scene,this.oldGeneration=i,this.newGeneration=this.oldGeneration,this.generation=[],this.signatures=[],this.renderArr=null,this.clone=function(t){return b=[],t.forEach(function(t){b.push(t.concat())}),b},this.findNeighbors=function(t,e){var i=[],n=this.oldGeneration;return 0==e?i.push(n[this.h-1][t]):i.push(n[e-1][t]),t<this.w-1&&0==e?i.push(n[this.h-1][t+1]):t==this.w-1&&0==e?i.push(n[this.h-1][0]):t==this.w-1&&e<this.h-1?i.push(n[e-1][0]):i.push(n[e-1][t+1]),t==this.w-1?i.push(n[e][0]):i.push(n[e][t+1]),t==this.w-1&&e<this.h-1?i.push(n[e+1][0]):t==this.w-1&&e==this.h-1?i.push(n[0][0]):t<this.w-1&&e==this.h-1?i.push(n[0][t+1]):i.push(n[e+1][t+1]),e==this.h-1?i.push(n[0][t]):i.push(n[e+1][t]),t>0&&e==this.h-1?i.push(n[0][t-1]):0==t&&e==this.h-1?i.push(n[0][this.w-1]):0==t&&e<this.h-1?i.push(n[e+1][this.w-1]):i.push(n[e+1][t-1]),0==t?i.push(n[e][this.w-1]):i.push(n[e][t-1]),0==t&&e>0?i.push(n[e-1][this.w-1]):0==t&&0==e?i.push(n[this.h-1][this.w-1]):t>0&&0==e?i.push(n[this.h-1][t-1]):i.push(n[e-1][t-1]),i},this.numberLiveNeighbors=function(t){for(var e=0,i=0;i<8;i++)1==t[i]&&e++;return e},this.step=function(){var t=this.isUniqueGeneration(this.createSignature(this.oldGeneration)),e=this.isEmptyGeneration(this.oldGeneration);if(0==t||1==e)return 0;var i,n;this.newGeneration=this.clone(this.oldGeneration);for(var s=0;s<this.h;s++)for(var r=0;r<this.w;r++)i=this.findNeighbors(r,s),n=this.numberLiveNeighbors(i),0==this.oldGeneration[s][r]&&3==n&&(this.newGeneration[s][r]=1),1==this.oldGeneration[s][r]&&(n<2||n>3)&&(this.newGeneration[s][r]=0);var a=this.createSignature(this.oldGeneration);this.signatures.push(a);var h=[a,this.oldGeneration];return this.generation.push(h),this.oldGeneration=this.clone(this.newGeneration),1},this.renderGeneration=function(){var t=this.x,e=this.y,i=this.wB,n=this.hB,s=this.scene,r=["#FFF","#000"];if(null==this.renderArr){this.renderArr=[],this.renderArr=new Array(this.h);for(var a=0;a<this.h;a++){this.renderArr[a]=new Array(this.w);for(var h=0;h<this.w;h++)this.renderArr[a][h]=s.createObj("rect",{x:h*i+i/2+t,y:a*n+n/2+e,width:i,height:n,layer:1}),this.renderArr[a][h].styles={fillC:r[this.oldGeneration[a][h]]}}}else for(var a=0;a<this.h;a++)for(var h=0;h<this.w;h++)this.renderArr[a][h].styles.fillC=r[this.oldGeneration[a][h]]},this.createSignature=function(t){for(var e="",i=0;i<t.length;i++)for(var n=0;n<t[i].length;n++)e+=t[i][n].toString();return e},this.isUniqueGeneration=function(t){for(var e=0;e<this.generation.length;e++)if(this.generation[e][0]==t)return 0;return 1},this.isEmptyGeneration=function(t){for(var e=0;e<t.length;e++)for(var i=0;i<t[e].length;i++)if(1==t[e][i])return 0;return t.length>0?1:0},this.prevGeneration=function(){var t=this.generation.length;this.oldGeneration=this.generation[t-1][1],this.generation.splice(t-1,1)}}var App=function(t){this.tmp={wW:t.wW,hW:t.hW,speed:t.speed,play:0,meter:0,lastTime:0,firstPlay:1},this.graphEngine=new SimpleGE("canvas"),this.scene=this.graphEngine.Scene.createScene(),this.GUI=new GUI(this,{play:"play",prev:"prev",next:"next"}),this.server=new ServerClass(this),this.startPatts=this.server.getStartPatts(),this.functions=new Functions(this),this.stats=this.functions.createStats(),this.automatons=[],this.colors=["#96A63E","#D22344","#005D61","#34854F"],this.update=function(t){var e=1/this.tmp.speed;if(this.tmp.meter>=e)for(var i=0;i<this.automatons.length;i++){var n=this.automatons[i].automaton,s=this.automatons[i].generation,r=n.step();n.renderGeneration(),r||this.automatons[i].end||(console.log("End: "+s),this.automatons[i].end=1),this.automatons[i].end||(this.automatons[i].generation++,this.automatons[i].generationEl.innerHTML="#"+this.automatons[i].id+": "+this.automatons[i].generation),this.tmp.meter=0}},this.Animate=function(){this.stats.begin();var t=Date.now(),e=(t-this.tmp.lastTime)/1e3;if(this.tmp.meter+=e,this.tmp.firstPlay){for(var i=0;i<this.automatons.length;i++){var n=this.automatons[i].automaton;this.automatons[i].generation;n.renderGeneration(),this.automatons[i].generationEl.innerHTML="#"+this.automatons[i].id+": "+this.automatons[i].generation}this.graphEngine.renderCanvas(),this.tmp.firstPlay=0;var s=document.getElementById("play");this.tmp.play?s.innerHTML="pause":s.innerHTML="play"}this.tmp.play&&(this.update(e),this.graphEngine.renderCanvas()),this.tmp.lastTime=t,this.stats.end(),requestAnimationFrame(this.Animate.bind(this))},requestAnimationFrame(this.Animate.bind(this)),this.createAutomaton=function(t){var e=new Automaton(t.width,t.height,t.arr,t.wB,t.hB,t.x,t.y,this),i=this.getRandomRange(0,this.colors.length-1),n=this.colors[i];this.colors.splice(i,1);var s=this.createBorder(t.x,t.y,t.wB,t.hB,t.width,t.height,n),r=this.createInfAutomaton(t),e={id:this.automatons.length,automaton:e,end:0,generation:0,generationEl:r,border:s,color:n};this.automatons.push(e);var a=document.createElement("option");a.value="#"+e.id,a.innerHTML=a.value,document.getElementById("selectAut").appendChild(a)},this.createInfAutomaton=function(t){var e=document.createElement("div");return document.body.appendChild(e),e.className="infEls",e.style.top=t.y+t.hB*t.height+5+"px",e.style.left=t.x+"px",e.innerHTML="#"+this.automatons.length+": 0",e},this.createBorder=function(t,e,i,n,s,r,a){var h=this.scene.createObj("rect",{x:t+i*s/2,y:e+n*r/2,w:i*s,h:n*s,l:2});return h.styles={borderColor:a,borderWidth:i},h},this.nextGeneration=function(){for(var t=0;t<this.automatons.length;t++){var e=(this.automatons[t],this.automatons[t].automaton),i=this.automatons[t].generation,n=e.step();e.renderGeneration(),this.graphEngine.renderCanvas(),n||this.automatons[t].end||(console.log("End: "+i),this.automatons[t].end=1),this.automatons[t].end||(this.automatons[t].generation++,this.automatons[t].generationEl.innerHTML="#"+this.automatons[t].id+": "+this.automatons[t].generation)}},this.prevGeneration=function(){for(var t=0;t<this.automatons.length;t++){var e=this.automatons[t];1==e.end&&(e.end=0),e.generation>0&&(e.automaton.prevGeneration(),e.automaton.renderGeneration(),this.graphEngine.renderCanvas(),e.generation--,e.generationEl.innerHTML="#"+this.automatons[t].id+": "+this.automatons[t].generation)}},this.getRandomRange=function(t,e){return Math.floor(Math.random()*(e-t+1))+t}},GUI=function(t,e){this.btns=e,this.play=document.getElementById(this.btns.play),this.prev=document.getElementById(this.btns.prev),this.next=document.getElementById(this.btns.next),this.flagPlay=t.tmp.play,this.playClick=function(){console.log(this),t.tmp.play=1==this.flagPlay?0:1,this.flagPlay=1==this.flagPlay?0:1,this.play.innerHTML=1==this.flagPlay?"pause":"play"},this.play.onclick=this.playClick.call(this),this.next.onclick=function(){t.nextGeneration()},this.prev.onclick=function(){t.prevGeneration()}},SimpleGE=function(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.width=600,this.height=600,null!=t&&(this.canvas.style.position="absolute",this.canvas.style.top=0,this.canvas.style.left=0,this.canvas.width=this.width,this.canvas.height=this.height),this.Scene=new Scenes(this.ctx),this.render=new Render(this.ctx,this.Scene),this.renderCanvas=function(){this.render.render()}},ObjectClass=function(){this.id,this.type,this.props={},this.styles={}},Objects=function(t){this.counter=0,this.objects=[],this.ctx=t,this.createObj=function(t,e){var i=new ObjectClass;return i.type=t,i.id=this.counter,this.counter++,i.props=e,this.objects.push(i),i.props.layer=e.layer||0,i}},Render=function(t,e){this.ctx=t,this.scenes=e,this.render=function(){var t=this.scenes.nowScene;for(var e in t.layers)for(var i in t.layers[e]){var n=t.layers[e][i],s=n.type;switch(s){case"rect":this.renderRect(n.props,n.styles);break;case"circle":this.renderCircle(n.props,n.styles);break;case"ellipse":this.renderEllipse(n.props,n.styles);break;case"line":this.renderLine(n.props,n.styles);break;case"curveLine":this.renderCurveLine(n.props,n.styles)}}},this.renderRect=function(t,e){var i=t.x||0,n=t.y||0,s=t.width||t.w||0,r=t.height||t.h||0;i-=s/2,n-=r/2;var a=e.borderWidth||e.borderW||0,h=e.fillColor||e.fillC||-1,o=e.borderColor||e.borderC||"black",l=e.rotate*Math.PI/180||0,c=e.alpha||1;this.ctx.globalAlpha=c,this.ctx.save(),this.ctx.translate(i+s/2,n+r/2),this.ctx.rotate(l),a>0&&(this.ctx.lineWidth=a,this.ctx.strokeStyle=o,this.ctx.strokeRect(-(s+a)/2,-(r+a)/2,s+a,r+a)),h!=-1&&(this.ctx.fillStyle=h,this.ctx.fillRect(-s/2,-r/2,s,r)),this.ctx.restore()},this.renderCircle=function(t,e){var i=t.x||0,n=t.y||0,s=t.radius||0,r=e.borderWidth||e.borderW||0,a=e.fillColor||e.fillC||-1,h=e.borderColor||e.borderC||"black",o=e.alpha||1;this.ctx.globalAlpha=o,this.ctx.beginPath(),this.ctx.arc(i,n,s+r/2,0,2*Math.PI,!1),a!=-1&&(this.ctx.fillStyle=a,this.ctx.fill()),r>0&&(this.ctx.lineWidth=r,this.ctx.strokeStyle=h,this.ctx.stroke())},this.renderEllipse=function(t,e){var i=t.x||0,n=t.y||0,s=t.width||t.w,r=t.height||t.h,a=e.borderWidth||e.borderW||0,h=e.fillColor||e.fillC||-1,o=e.borderColor||e.borderC||"black",l=e.rotate*Math.PI/180,c=e.alpha||1;this.ctx.globalAlpha=c,this.ctx.beginPath(),this.ctx.ellipse(i,n,s+a/2,r+a/2,l,0,2*Math.PI),h!=-1&&(this.ctx.fillStyle=h,this.ctx.fill()),a>0&&(this.ctx.lineWidth=a,this.ctx.strokeStyle=o,this.ctx.stroke())},this.renderLine=function(t,e){var i=t.x||0,n=t.y||0,s=t.endX||0,r=t.endY||0,a=t.width||t.w,h=e.borderWidth||e.borderW||0,o=e.fillColor||e.fillC||-1,l=e.borderColor||e.borderC||"black",c=e.alpha||1;this.ctx.globalAlpha=c,o!=-1&&(this.ctx.beginPath(),this.ctx.moveTo(i-h,n-h),this.ctx.lineTo(s+h,r+h),this.ctx.strokeStyle=l,this.ctx.lineWidth=a+2*h,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,n),this.ctx.lineTo(s,r),this.ctx.strokeStyle=o,this.ctx.lineWidth=a,this.ctx.stroke())},this.renderCurveLine=function(t,e){var i=t.points,n=t.width||t.w,s=t.layer||t.l||0,r=(e.borderWidth||e.borderW||0,e.fillColor||e.fillC||-1);if(e.borderColor||e.borderC||"black",e.alpha||1,r!=-1){var a=[];for(var h in i){var o=i[h].x,l=i[h].y;a.push(o),a.push(l)}for(var c=0;c<a.length-3;c+=2){var u=a[c],d=a[c+1],p=a[c+2],f=a[c+3];this.renderLine({x:u,y:d,endX:p,endY:f,w:n,l:s},e)}}}},Scene=function(t){this.id,this.ctx=t,this.objects=new Objects(this.ctx),this.layers={},this.createObj=function(t,e){var i=this.objects.createObj(t,e),n=i.props.layer||i.props.l||0,s=i.id;return this.layers[n]=this.layers[n]||{},this.layers[n][s]=i,i}},Scenes=function(t){this.ctx=t,this.counter=0,this.scenes=[],this.nowScene,this.createScene=function(){var t=new Scene(this.ctx);return t.id=this.counter,0==this.counter&&(this.nowScene=t),this.counter++,t}},Functions=function(t){this.mainClass=t,this.setBgc=function(t){var e=this.mainClass.scene,i=this.mainClass.tmp.wW,n=this.mainClass.tmp.hW,s=e.createObj("rect",{x:i/2,y:n/2,w:i,h:n,layer:0});s.styles={fillC:t},this.mainClass.graphEngine.renderCanvas()},this.createStats=function(){var t=new Stats;t.domElement.offsetWidth;return t.setMode(0),t.domElement.style.position="absolute",t.domElement.style.left=window.innerWidth-80+"px",t.domElement.style.top="0px",document.body.appendChild(t.domElement),t},this.generateRandArr=function(t,e,i){for(var n,s=new Array(e),r=0;r<e;r++){s[r]=new Array(t);for(var a=0;a<t;a++)n=Math.random(),s[r][a]=n>i?0:1}return s},this.generateArrByStartPattern=function(t,e,i){var n=i[0].length,s=i.length;if(t<n||e<s)return i;var r=[];r=new Array(e);for(var a=0;a<e;a++){r[a]=new Array(t);for(var h=0;h<t;h++)r[a][h]=0}for(var o=Math.ceil(t/2)-Math.ceil(n/2),l=Math.ceil(e/2)-Math.ceil(s/2),a=l;a<s+l;a++)for(var h=o;h<n+o;h++)r[a][h]=i[a-l][h-o];return r}},ServerClass=function(t){this.mainClass=t,this.getStartPatts=function(){var t=[[0,1,0],[0,0,1],[1,1,1]],e=[[0,1,1],[1,1,0],[0,1,0]],i=[[0,1,0,0,0,0,0],[0,0,0,1,0,0,0],[1,1,0,0,1,1,1]],n=[[0,1,0],[1,1,1],[0,1,0],[0,1,0]],s=[[1,0,1],[1,1,1],[1,0,1]],r=[t,e,i,n,s];return r}},Stats=function(){function t(t){return n.appendChild(t.dom),t}function e(t){for(var e=0;e<n.children.length;e++)n.children[e].style.display=e===t?"block":"none";i=t}var i=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(t){t.preventDefault(),e(++i%n.children.length)},!1);var s=(performance||Date).now(),r=s,a=0,h=t(new Stats.Panel("FPS","#0ff","#002")),o=t(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=t(new Stats.Panel("MB","#f08","#201"));return e(0),{REVISION:16,dom:n,addPanel:t,showPanel:e,begin:function(){s=(performance||Date).now()},end:function(){a++;var t=(performance||Date).now();if(o.update(t-s,200),t>r+1e3&&(h.update(1e3*a/(t-r),100),r=t,a=0,l)){var e=performance.memory;l.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){s=this.end()},domElement:n,setMode:e}};Stats.Panel=function(t,e,i){var n=1/0,s=0,r=Math.round,a=r(window.devicePixelRatio||1),h=80*a,o=48*a,l=3*a,c=2*a,u=3*a,d=15*a,p=74*a,f=30*a,m=document.createElement("canvas");m.width=h,m.height=o,m.style.cssText="width:80px;height:48px";var g=m.getContext("2d");return g.font="bold "+9*a+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=i,g.fillRect(0,0,h,o),g.fillStyle=e,g.fillText(t,l,c),g.fillRect(u,d,p,f),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u,d,p,f),{dom:m,update:function(o,v){n=Math.min(n,o),s=Math.max(s,o),g.fillStyle=i,g.globalAlpha=1,g.fillRect(0,0,h,d),g.fillStyle=e,g.fillText(r(o)+" "+t+" ("+r(n)+"-"+r(s)+")",l,c),g.drawImage(m,u+a,d,p-a,f,u,d,p-a,f),g.fillRect(u+p-a,d,a,f),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u+p-a,d,a,r((1-o/v)*f))}}},"object"==typeof module&&(module.exports=Stats);